name: Publish to npm

on:
  release:
    types: [published]

jobs:
  publish-npm:
    name: Publish to npm Registry
    runs-on: ubuntu-latest
    # Only run on releases from the main branch
    if: github.event.release.target_commitish == 'main'
    permissions:
      contents: read
      id-token: write # Required for npm provenance
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify release tag matches package.json version
        run: |
          PACKAGE_VERSION=$(node -p "require('./apps/cli/package.json').version")
          RELEASE_TAG=${GITHUB_REF#refs/tags/}
          echo "Package version: $PACKAGE_VERSION"
          echo "Release tag: $RELEASE_TAG"
          if [ "v$PACKAGE_VERSION" != "$RELEASE_TAG" ] && [ "$PACKAGE_VERSION" != "$RELEASE_TAG" ]; then
            echo "âŒ Error: Package version ($PACKAGE_VERSION) does not match release tag ($RELEASE_TAG)"
            exit 1
          fi
          echo "âœ… Version check passed"

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: |
          pnpm --filter @find-my-domain/core run build
          pnpm --filter find-my-domain run build

      - name: Run quality checks
        run: |
          pnpm --filter @find-my-domain/core run typecheck
          pnpm --filter find-my-domain run typecheck
          pnpm --filter find-my-domain run lint
          pnpm --filter find-my-domain run test

      - name: Verify build artifacts
        run: |
          if [ ! -d "apps/cli/dist" ]; then
            echo "âŒ Error: apps/cli/dist directory not found"
            exit 1
          fi
          if [ ! -f "apps/cli/dist/index.js" ]; then
            echo "âŒ Error: apps/cli/dist/index.js not found"
            exit 1
          fi
          echo "âœ… Build artifacts verified"

      - name: Publish CLI to npm
        working-directory: ./apps/cli
        run: pnpm publish --provenance --access public --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create release summary
        if: success()
        run: |
          echo "## ðŸŽ‰ Successfully Published to npm" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: find-my-domain" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $(node -p "require('./apps/cli/package.json').version")" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: https://www.npmjs.com/package/find-my-domain" >> $GITHUB_STEP_SUMMARY

